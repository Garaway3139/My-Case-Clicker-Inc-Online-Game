<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Clicker Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Arial', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chat-message { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .server-message { color: #00ffff; font-style: italic; }
        .player-message .sender { font-weight: bold; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        .skin-card { transition: all 0.2s ease-in-out; cursor: pointer; border: 2px solid transparent; }
        .skin-card.selected { border-color: #00ffff; transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 255, 255, 0.5); }
        .tier-button.active { background-color: #00ffff; color: #1a202c; }
    </style>
</head>
<body class="bg-gray-900 text-cyan-300 overflow-hidden h-screen">

    <!-- Main Game Container -->
    <div id="game-container" class="hidden w-full h-screen p-4 flex flex-col md:flex-row gap-4">
        <div class="flex-grow flex flex-col gap-4 w-full md:w-1/3">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 id="username-display" class="text-2xl font-bold text-white">Player</h2>
                <div class="grid grid-cols-3 gap-2 mt-2 text-lg items-center">
                    <p>üéñÔ∏è Rank: <span id="rank-stat" class="font-mono text-yellow-400"></span></p>
                    <p>üí∞ Money: <span id="money-stat" class="font-mono text-green-400">0</span></p>
                    <p>üñ±Ô∏è Clicks: <span id="clicks-stat" class="font-mono text-cyan-400">0</span></p>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col items-center justify-center">
                <button id="click-button" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold text-4xl py-16 px-24 rounded-full transition-transform transform hover:scale-105 active:scale-95 shadow-2xl">Click!</button>
                <div class="grid grid-cols-3 gap-2 mt-8 w-full">
                    <button onclick="openModal('shop-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Shop</button>
                    <button onclick="openModal('inventory-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Inventory</button>
                    <button onclick="openModal('online-players-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Online</button>
                </div>
            </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col w-full md:w-2/3">
            <h3 class="text-xl font-bold text-white mb-2 border-b border-gray-700 pb-2">Global Chat</h3>
            <div id="chat-box" class="flex-grow overflow-y-auto mb-2 pr-2 space-y-2"></div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" class="flex-grow bg-gray-700 text-white rounded-lg p-2" placeholder="Type a message...">
                <button id="send-chat-button" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg">Send</button>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="w-full h-screen flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <h1 class="text-4xl font-bold text-white mb-4">Case Clicker Online</h1>
            <div class="space-y-4">
                <input type="text" id="username-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center text-lg" placeholder="Enter Username" autocomplete="username">
                <input type="password" id="password-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center text-lg" placeholder="Enter Password" autocomplete="current-password">
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="login-button" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg text-lg">Login</button>
                <button id="signup-button" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg text-lg">Sign Up</button>
            </div>
            <button onclick="openModal('admin-modal')" class="w-full mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded-lg">Admin Login</button>
            <p id="login-error" class="text-red-400 mt-4 h-6"></p>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shop-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-7xl h-full flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                <h2 class="text-3xl text-white font-bold">Case Shop</h2>
                <div class="text-2xl text-green-400 font-mono">üí∞ <span id="shop-money-stat">0</span></div>
                <button onclick="closeModal('shop-modal')" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="shop-tier-buttons" class="flex flex-wrap gap-2 mb-4 overflow-x-auto pb-2"></div>
            <div id="shop-case-list" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-2"></div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventory-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <!-- ... same as before ... -->
    </div>

    <!-- Online Players Modal -->
    <div id="online-players-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-md h-2/3 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-2xl text-white font-bold">Online Players</h2>
                <button onclick="closeModal('online-players-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="online-player-list" class="flex-grow overflow-y-auto"></div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-4xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-2xl text-white font-bold">Admin Panel</h2>
                <button onclick="closeModal('admin-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="admin-login-view">
                <input type="password" id="admin-password-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center" placeholder="Enter Admin Password">
                <button id="admin-submit-password" class="w-full mt-4 bg-cyan-600 text-white font-bold py-3 rounded-lg">Authenticate</button>
            </div>
            <div id="admin-data-view" class="hidden flex-grow overflow-hidden flex-col">
                <h3 class="text-xl font-bold text-white">Online Players (<span id="admin-online-count">0</span>)</h3>
                <div id="admin-player-list" class="bg-gray-900 p-2 rounded-lg overflow-auto h-1/3 my-2"></div>
                <h3 class="text-xl font-bold text-white mt-4">Moderator Actions</h3>
                <div class="grid grid-cols-2 gap-4 p-2 bg-gray-900 rounded-lg">
                    <input id="admin-target-user" class="bg-gray-700 p-2 rounded col-span-2" placeholder="Target Username">
                    <button id="admin-kick-button" class="bg-red-600 p-2 rounded">Kick Player</button>
                    <div class="flex gap-2">
                        <input id="admin-money-amount" type="number" class="bg-gray-700 p-2 rounded w-full" placeholder="Amount">
                        <button id="admin-give-money-button" class="bg-green-600 p-2 rounded">Give Money</button>
                    </div>
                </div>
                <div id="main-admin-actions" class="hidden mt-4">
                    <h3 class="text-xl font-bold text-white">Admin-Only Actions</h3>
                    <div class="flex gap-4 p-2 bg-gray-900 rounded-lg">
                        <button id="admin-promote-button" class="bg-blue-600 p-2 rounded">Promote to Moderator</button>
                        <button id="admin-demote-button" class="bg-yellow-600 p-2 rounded">Demote to Player</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<script>
// --- Client-Side Game Logic ---
const API_URL = window.location.origin;

let gameState = {
    username: null,
    password: null,
    playerData: { clicks: 0, money: 0, skins: [], cases: {}, role: 'player' },
    lastGlobalChatId: '0',
    adminPassword: null,
    selectedSkinIds: new Set(),
    onlinePlayers: [],
};
let gameData = {};
let gameLoopInterval = null;

// --- DOM Elements ---
const DOMElements = {
    loginScreen: document.getElementById('login-screen'),
    gameContainer: document.getElementById('game-container'),
    usernameInput: document.getElementById('username-input'),
    passwordInput: document.getElementById('password-input'),
    loginButton: document.getElementById('login-button'),
    signupButton: document.getElementById('signup-button'),
    loginError: document.getElementById('login-error'),
    usernameDisplay: document.getElementById('username-display'),
    moneyStat: document.getElementById('money-stat'),
    clicksStat: document.getElementById('clicks-stat'),
    rankStat: document.getElementById('rank-stat'),
    clickButton: document.getElementById('click-button'),
    chatBox: document.getElementById('chat-box'),
    chatInput: document.getElementById('chat-input'),
    sendChatButton: document.getElementById('send-chat-button'),
    shopModal: document.getElementById('shop-modal'),
    shopCaseList: document.getElementById('shop-case-list'),
    shopTierButtons: document.getElementById('shop-tier-buttons'),
    shopMoneyStat: document.getElementById('shop-money-stat'),
    inventoryModal: document.getElementById('inventory-modal'),
    inventoryCaseList: document.getElementById('inventory-case-list'),
    inventorySkinList: document.getElementById('inventory-skin-list'),
    skinCount: document.getElementById('skin-count'),
    sellButtonContainer: document.getElementById('sell-button-container'),
    sellSelectedBtn: document.getElementById('sell-selected-btn'),
    adminModal: document.getElementById('admin-modal'),
    adminLoginView: document.getElementById('admin-login-view'),
    adminPasswordInput: document.getElementById('admin-password-input'),
    adminSubmitPassword: document.getElementById('admin-submit-password'),
    adminDataView: document.getElementById('admin-data-view'),
    adminPlayerList: document.getElementById('admin-player-list'),
    adminOnlineCount: document.getElementById('admin-online-count'),
    adminTargetUser: document.getElementById('admin-target-user'),
    adminKickButton: document.getElementById('admin-kick-button'),
    adminMoneyAmount: document.getElementById('admin-money-amount'),
    adminGiveMoneyButton: document.getElementById('admin-give-money-button'),
    mainAdminActions: document.getElementById('main-admin-actions'),
    adminPromoteButton: document.getElementById('admin-promote-button'),
    adminDemoteButton: document.getElementById('admin-demote-button'),
    onlinePlayersModal: document.getElementById('online-players-modal'),
    onlinePlayerList: document.getElementById('online-player-list'),
};

// --- Helper Functions ---
function formatNumber(num) {
    if (num < 10000) return num.toLocaleString();
    const suffixes = ["", "k", "M", "B", "T", "q", "Q"];
    const i = Math.floor(Math.log10(num) / 3);
    const shortNum = (num / Math.pow(1000, i)).toFixed(2);
    return shortNum + suffixes[i];
}

async function apiRequest(endpoint, body) {
    try {
        const response = await fetch(`${API_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || `HTTP error! status: ${response.status}`);
        return data;
    } catch (error) {
        console.error(`API request to ${endpoint} failed:`, error);
        DOMElements.loginError.textContent = error.message;
        return { success: false, message: error.message };
    }
}

// --- Local Storage ---
function saveCredentials() {
    try {
        const credentials = {
            username: DOMElements.usernameInput.value,
            password: DOMElements.passwordInput.value,
            adminPassword: gameState.adminPassword
        };
        localStorage.setItem('caseClickerCreds', JSON.stringify(credentials));
    } catch (e) { console.error("Failed to save credentials:", e); }
}

function loadCredentials() {
    try {
        const savedCreds = localStorage.getItem('caseClickerCreds');
        if (savedCreds) {
            const parsed = JSON.parse(savedCreds);
            DOMElements.usernameInput.value = parsed.username || '';
            DOMElements.passwordInput.value = parsed.password || '';
            gameState.adminPassword = parsed.adminPassword || null;
        }
    } catch (e) { console.error("Failed to load credentials:", e); }
}

// --- UI Rendering ---
function updateUI() {
    if (!gameState.playerData) return;
    const { money, clicks, rank } = gameState.playerData;
    DOMElements.moneyStat.textContent = formatNumber(money || 0);
    DOMElements.shopMoneyStat.textContent = formatNumber(money || 0);
    DOMElements.clicksStat.textContent = formatNumber(clicks || 0);
    DOMElements.rankStat.textContent = rank ? rank.name : "N/A";
    DOMElements.usernameDisplay.textContent = gameState.username;
    
    // Only show admin actions if user has the right role
    const userRole = gameState.playerData.role;
    DOMElements.mainAdminActions.classList.toggle('hidden', userRole !== 'admin');

    renderInventorySkins();
    renderInventoryCases();
    updateSellButton();
}

// ... other render functions (inventory, chat) are complex and mostly unchanged ...

function setupShopTiers() {
    DOMElements.shopTierButtons.innerHTML = '';
    for (let i = 1; i <= 20; i++) {
        const button = document.createElement('button');
        button.className = 'tier-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg';
        button.textContent = `T${i}`;
        button.onclick = () => renderShopCases(i);
        DOMElements.shopTierButtons.appendChild(button);
    }
}

function renderShopCases(tier) {
    document.querySelectorAll('.tier-button').forEach((btn, index) => {
        btn.classList.toggle('active', index + 1 === tier);
    });
    DOMElements.shopCaseList.innerHTML = '';
    const filteredCases = Object.entries(gameData.cases).filter(([, data]) => data.tier === tier);
    for (const [caseName, caseInfo] of filteredCases) {
        const div = document.createElement('div');
        div.className = 'bg-gray-700 p-4 rounded-lg flex flex-col items-center';
        div.innerHTML = `
            <h4 class="text-lg font-bold text-white text-center">${caseName}</h4>
            <p class="text-green-400 font-mono my-2">$${parseFloat(caseInfo.price).toLocaleString()}</p>
            <button class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg mt-auto" onclick="buyCase('${caseName}')">Buy</button>
        `;
        DOMElements.shopCaseList.appendChild(div);
    }
}

function renderOnlinePlayers(players) {
    DOMElements.onlinePlayerList.innerHTML = '';
    players.forEach(p => {
        if (p.display_name === gameState.username) return; // Don't show self
        const div = document.createElement('div');
        div.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center mb-2';
        div.innerHTML = `<span class="text-white font-bold">${p.display_name}</span>
                         <div>
                            <button class="bg-cyan-600 text-white py-1 px-3 rounded text-sm">Chat</button>
                         </div>`;
        DOMElements.onlinePlayerList.appendChild(div);
    });
}

// --- Game Logic ---
async function handleLogin() {
    const user = DOMElements.usernameInput.value.trim();
    const pass = DOMElements.passwordInput.value;
    if (!user || !pass) {
        DOMElements.loginError.textContent = 'Username and password are required.';
        return;
    }
    DOMElements.loginButton.disabled = true;
    DOMElements.signupButton.disabled = true;
    DOMElements.loginError.textContent = '';

    const result = await apiRequest('/api/login', { username: user, password: pass });

    if (result.success) {
        gameState.username = result.username;
        gameState.playerData = result.player_data;
        DOMElements.loginScreen.classList.add('hidden');
        DOMElements.gameContainer.classList.remove('hidden');
        saveCredentials(); // Save on successful login
        await loadStaticData();
        updateUI();
        startGameLoop();
    } else {
        DOMElements.loginError.textContent = result.message;
    }
    DOMElements.loginButton.disabled = false;
    DOMElements.signupButton.disabled = false;
}

// ... other handlers (signup, click, buy, sell, etc.) ...

// --- Game Initialization & Loop ---
function startGameLoop() {
    if (gameLoopInterval) clearInterval(gameLoopInterval);
    gameLoopInterval = setInterval(updateGameState, 3000);
}

async function updateGameState() {
    if (!gameState.username) return;
    const result = await apiRequest('/api/game_state', { username: gameState.username });
    if (result.success) {
        gameState.playerData = result.player_data;
        gameState.onlinePlayers = result.online_players;
        updateUI();
        renderOnlinePlayers(result.online_players);
    } else {
        // Handle logout on error
        clearInterval(gameLoopInterval);
        localStorage.removeItem('caseClickerCreds');
        location.reload();
    }
}

async function loadStaticData() {
    try {
        gameData = await fetch(`${API_URL}/api/game_data/all`).then(res => res.json());
        setupShopTiers();
        renderShopCases(1); // Load Tier 1 by default
    } catch (e) {
        console.error("Failed to load static game data:", e);
        DOMElements.loginError.textContent = "Could not connect to game servers.";
    }
}

function init() {
    loadCredentials();
    DOMElements.loginButton.addEventListener('click', handleLogin);
    // ... all other event listeners
}

init();

</script>
</body>
</html>

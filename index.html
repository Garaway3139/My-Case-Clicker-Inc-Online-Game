<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Clicker Inc.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Arial', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chat-message { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        .chat-tab { transition: background-color 0.2s; }
        .chat-tab.active { background-color: #0891b2; color: white; border-color: #0891b2; }
    </style>
</head>
<body class="bg-gray-900 text-cyan-300 overflow-hidden h-screen">

    <div id="game-container" class="hidden w-full h-screen p-4 flex flex-col md:flex-row gap-4">
        <div class="flex-grow flex flex-col gap-4 w-full md:w-1/3">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <div class="flex justify-between items-center">
                    <h2 id="username-display" class="text-2xl font-bold text-white">Player</h2>
                    <button id="logout-button" class="bg-red-600 hover:bg-red-500 text-white text-sm font-bold py-1 px-3 rounded-lg">Logout</button>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-2 text-lg">
                    <p>Rank: <span id="rank-stat" class="font-mono text-yellow-400"></span></p>
                    <p>üí∞ Money: <span id="money-stat" class="font-mono text-green-400">0</span></p>
                    <p>üñ±Ô∏è Clicks: <span id="clicks-stat" class="font-mono text-yellow-400">0</span></p>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col items-center justify-center">
                <button id="click-button" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold text-4xl py-16 px-24 rounded-full">Click!</button>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-8 w-full">
                    <button onclick="openModal('shop-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Shop</button>
                    <button onclick="openModal('inventory-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Inventory</button>
                    <button onclick="openModal('leaderboard-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Leaders</button>
                    <button id="staff-panel-button" class="hidden bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 rounded-lg">Staff</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-4 w-full md:w-2/3 h-full">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col h-1/2">
                <div id="chat-tabs" class="flex border-b border-gray-700 mb-2"></div>
                <div id="chat-area" class="flex-grow overflow-y-auto mb-2 pr-2 space-y-2"></div>
                <div id="private-chat-target" class="hidden mb-2 text-sm"></div>
                <div class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow bg-gray-700 text-white rounded-lg p-2" placeholder="Type a message...">
                    <button id="send-chat-button" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="login-screen" class="w-full h-screen flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <h1 class="text-4xl font-bold text-white mb-6">Case Clicker Inc.</h1>
            <input type="text" id="username-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center text-lg mb-4" placeholder="Username">
            <input type="password" id="password-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center text-lg" placeholder="Password">
            <div class="flex gap-4 mt-6">
                <button id="login-button" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg">Login</button>
                <button id="signup-button" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">Sign Up</button>
            </div>
            <p id="login-error" class="text-red-400 mt-4 h-6"></p>
        </div>
    </div>
    
    <div id="shop-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-20"></div>
    <div id="inventory-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-20"></div>
    <div id="leaderboard-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-20"></div>
    <div id="staff-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-30"></div>
    <div id="unboxing-modal" class="modal fixed inset-0 bg-black bg-opacity-85 items-center justify-center z-50"></div>
    <div id="private-chat-select-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-40"></div>


<script>
// --- Client-Side Game Logic ---
const API_URL = window.location.origin;
let gameState = { 
    username: null, 
    playerData: {}, 
    onlinePlayers: [], 
    chats: { global: [], staff: {} }, 
    activeChat: { channel: 'global', target: null } 
};
let gameData = {};
let updateInterval;

// --- API Helper ---
async function apiRequest(endpoint, body = {}, method = 'POST') {
    try {
        const options = {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: method !== 'GET' ? JSON.stringify(body) : undefined
        };
        const response = await fetch(`${API_URL}${endpoint}`, options);
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'An unknown server error occurred.');
        return data;
    } catch (error) {
        console.error(`API Error at ${endpoint}:`, error.message);
        document.getElementById('login-error').textContent = error.message;
        return { success: false, message: error.message };
    }
}

// --- Modal Management ---
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modalId === 'staff-modal') renderAdminPanel();
    if (modalId === 'leaderboard-modal') renderLeaderboards();
    if (modalId === 'inventory-modal') renderInventory();
    if (modalId === 'shop-modal') renderShop();
    modal.classList.add('active');
}
function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }

// --- UI Rendering ---
function updateStats() {
    const p = gameState.playerData;
    if (!p) return;
    document.getElementById('username-display').textContent = gameState.username;
    document.getElementById('money-stat').textContent = `$${(p.money || 0).toLocaleString()}`;
    document.getElementById('clicks-stat').textContent = (p.clicks || 0).toLocaleString();
    const rankName = gameData.ranks?.[p.rank]?.name || 'Unranked';
    document.getElementById('rank-stat').textContent = rankName;
}

function renderInventory() {
    // This function now generates the full modal content to ensure it's always fresh
    const modal = document.getElementById('inventory-modal');
    modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-6xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-2xl text-white font-bold">Inventory</h2>
                <button onclick="closeModal('inventory-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex flex-grow overflow-hidden gap-4">
                <div class="w-1/3 flex flex-col">
                    <h3 class="text-xl font-bold text-white mb-2">My Cases</h3>
                    <div id="inventory-case-list" class="flex-grow overflow-y-auto bg-gray-900 p-2 rounded-lg"></div>
                </div>
                <div class="w-2/3 flex flex-col">
                    <h3 class="text-xl font-bold text-white mb-2">My Skins (<span id="skin-count">0</span>)</h3>
                    <div id="inventory-skin-list" class="flex-grow overflow-y-auto bg-gray-900 p-2 rounded-lg grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                </div>
            </div>
        </div>`;

    const caseList = document.getElementById('inventory-case-list');
    const skinList = document.getElementById('inventory-skin-list');
    caseList.innerHTML = '';
    skinList.innerHTML = '';

    Object.entries(gameState.playerData.cases || {}).sort(([a],[b])=> a.localeCompare(b)).forEach(([name, count]) => {
        if (count > 0) {
            const div = document.createElement('div');
            div.className = 'bg-gray-700 p-2 rounded mb-2 flex justify-between items-center';
            div.innerHTML = `<div><p class="font-bold">${name}</p><p class="text-sm text-gray-400">Owned: ${count}</p></div><button class="bg-green-600 p-2 rounded text-sm font-bold">Open</button>`;
            div.querySelector('button').onclick = () => handleOpenCase(name);
            caseList.appendChild(div);
        }
    });

    (gameState.playerData.skins || []).sort((a,b) => b.value - a.value).forEach(skin => {
        const div = document.createElement('div');
        div.className = 'bg-gray-700 p-2 rounded';
        div.innerHTML = `<p class="font-bold truncate">${skin.name}</p><p class="text-green-400 text-sm">$${skin.value.toLocaleString()}</p>`;
        skinList.appendChild(div);
    });
    document.getElementById('skin-count').textContent = (gameState.playerData.skins || []).length;
}

function renderShop() {
    const modal = document.getElementById('shop-modal');
    modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-6xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-2xl text-white font-bold">Case Shop</h2>
                <button onclick="closeModal('shop-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="shop-tier-buttons" class="flex flex-wrap gap-2 p-2 overflow-x-auto"></div>
            <div id="shop-case-list" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-4 gap-4 p-2"></div>
        </div>`;
    
    const tierContainer = document.getElementById('shop-tier-buttons');
    const caseContainer = document.getElementById('shop-case-list');
    let activeTier = 1;

    function displayCases() {
        caseContainer.innerHTML = '';
        const cases = Object.entries(gameData.cases || {}).filter(([,c]) => c.tier === activeTier);
        cases.forEach(([name, caseInfo]) => {
            const div = document.createElement('div');
            div.className = 'bg-gray-700 p-4 rounded-lg';
            div.innerHTML = `<h4 class="text-lg font-bold text-white truncate">${name}</h4><p class="text-green-400 font-mono">$${parseFloat(caseInfo.price).toLocaleString()}</p>`;
            caseContainer.appendChild(div);
        });
    }

    for (let i = 1; i <= 20; i++) {
        const button = document.createElement('button');
        button.className = 'bg-gray-700 p-2 rounded';
        if (i === activeTier) button.classList.add('bg-cyan-600');
        button.textContent = `T${i}`;
        button.onclick = () => {
            activeTier = i;
            tierContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-cyan-600'));
            button.classList.add('bg-cyan-600');
            displayCases();
        };
        tierContainer.appendChild(button);
    }
    displayCases(); // Initial render
}

function renderLeaderboards() {
    const modal = document.getElementById('leaderboard-modal');
    modal.innerHTML = `<div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-5xl h-5/6 flex flex-col p-4">
        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
            <h2 class="text-2xl text-white font-bold">Leaderboards</h2>
            <button onclick="closeModal('leaderboard-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div id="leaderboard-content" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-3 gap-4">Loading...</div>
    </div>`;

    apiRequest('/api/leaderboards', {}, 'GET').then(data => {
        const content = document.getElementById('leaderboard-content');
        content.innerHTML = '';
        const boardTitles = {
            most_clicks: "Most Clicks", most_money: "Richest Players",
            inventory_value: "Highest Inventory Value", highest_skin_value: "Most Valuable Skin",
            most_cases_opened: "Most Cases Opened"
        };
        for (const [key, title] of Object.entries(boardTitles)) {
            const boardData = data[key] || [];
            const div = document.createElement('div');
            div.className = 'bg-gray-900 p-3 rounded-lg';
            let listHtml = `<h4 class="text-white font-bold text-lg mb-2">${title}</h4><ol class="list-decimal list-inside space-y-1 text-sm">`;
            boardData.forEach(p => {
                listHtml += `<li class="truncate">${p.username} - <span class="font-mono text-green-300">${(p.value || 0).toLocaleString()}</span></li>`;
            });
            listHtml += '</ol>';
            div.innerHTML = listHtml;
            content.appendChild(div);
        }
    });
}

// --- Chat System ---
function setupChatTabs() {
    const tabsContainer = document.getElementById('chat-tabs');
    tabsContainer.innerHTML = '';
    let availableTabs = { global: 'Global' };
    if (['helpdesk', 'moderator', 'admin'].includes(gameState.playerData.role)) {
        availableTabs.staff = 'Staff';
    }
    availableTabs.private = 'Private'; // Add a permanent private tab

    for (const channelId in availableTabs) {
        const tab = document.createElement('button');
        tab.className = 'chat-tab px-4 py-2 text-sm border-b-2 border-transparent';
        tab.textContent = availableTabs[channelId];
        if (channelId === gameState.activeChat.channel) tab.classList.add('active');
        
        tab.onclick = () => {
            if (channelId === 'private') {
                openPrivateChatSelector();
            } else {
                switchChatTab(channelId);
            }
        };
        tabsContainer.appendChild(tab);
    }
}
function switchChatTab(channel, target = null) {
    gameState.activeChat = { channel, target };
    const targetEl = document.getElementById('private-chat-target');
    if (target) {
        targetEl.innerHTML = `Chatting with: <strong>${target}</strong> <button onclick="switchChatTab('global')" class="text-red-400 ml-2">[x]</button>`;
        targetEl.classList.remove('hidden');
    } else {
        targetEl.classList.add('hidden');
    }
    setupChatTabs();
    renderChatMessages();
}
function renderChatMessages() {
    const chatArea = document.getElementById('chat-area');
    chatArea.innerHTML = '';
    let channelId = gameState.activeChat.channel;
    if (channelId === 'private') {
        channelId = [gameState.username, gameState.activeChat.target].sort().join('-');
    }
    const messages = gameState.chats[channelId] || [];
    messages.forEach(msg => {
        const div = document.createElement('div');
        div.innerHTML = `<strong class="font-bold text-cyan-400">${msg.sender}:</strong> ${msg.msg}`;
        chatArea.appendChild(div);
    });
    chatArea.scrollTop = chatArea.scrollHeight;
}
function openPrivateChatSelector() {
    const modal = document.getElementById('private-chat-select-modal');
    let playerListHTML = gameState.onlinePlayers.filter(p => p !== gameState.username)
        .map(p => `<li class="p-2 hover:bg-gray-700 cursor-pointer rounded" onclick="startPrivateChat('${p}')">${p}</li>`).join('');
    
    modal.innerHTML = `
        <div class="bg-gray-800 p-4 rounded-lg w-full max-w-sm">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl text-white font-bold">Start Private Chat</h2>
                <button onclick="closeModal('private-chat-select-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <ul class="space-y-1">${playerListHTML || 'No other players online.'}</ul>
        </div>`;
    modal.classList.add('active');
}
function startPrivateChat(targetUsername) {
    const convoKey = [gameState.username, targetUsername].sort().join('-');
    if (!gameState.chats[convoKey]) gameState.chats[convoKey] = [];
    switchChatTab('private', targetUsername);
    closeModal('private-chat-select-modal');
}

// --- Admin Panel ---
async function renderAdminPanel() {
    const modal = document.getElementById('staff-modal');
    modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-7xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-2xl text-white font-bold">Staff Panel</h2>
                <button onclick="closeModal('staff-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex flex-grow overflow-hidden gap-4 h-full">
                <div class="w-1/3 flex flex-col h-full">
                    <input type="text" id="player-search-input" placeholder="Search players..." class="w-full bg-gray-900 p-2 rounded mb-2">
                    <div id="admin-player-list" class="flex-grow overflow-y-auto bg-gray-900 p-2 rounded-lg"></div>
                </div>
                <div id="admin-player-details" class="w-2/3 bg-gray-900 p-4 rounded-lg overflow-y-auto">Select a player...</div>
            </div>
        </div>`;
    
    const data = await apiRequest('/api/admin/all_players', { username: gameState.username });
    if (!data.success) { document.getElementById('admin-player-list').textContent = data.message; return; }
    
    const playerList = Object.entries(data).filter(([name, pdata]) => pdata.role !== "ai");
    const listEl = document.getElementById('admin-player-list');

    const displayPlayers = (players) => {
        listEl.innerHTML = '';
        players.sort(([a],[b])=> a.localeCompare(b)).forEach(([username]) => {
            const div = document.createElement('div');
            div.className = 'p-2 hover:bg-gray-700 cursor-pointer rounded';
            div.textContent = username;
            div.onclick = () => showPlayerDetails(username);
            listEl.appendChild(div);
        });
    };
    displayPlayers(playerList);
    document.getElementById('player-search-input').onkeyup = (e) => {
        const term = e.target.value.toLowerCase();
        displayPlayers(playerList.filter(([name]) => name.toLowerCase().includes(term)));
    };
}
async function showPlayerDetails(username) {
    const detailsEl = document.getElementById('admin-player-details');
    detailsEl.innerHTML = 'Loading...';
    const data = await apiRequest(`/api/admin/player_details/${username}`, { username: gameState.username });
    if (!data.success) { detailsEl.innerHTML = data.message; return; }
    const p = data.player;
    const canEditValues = gameState.playerData.role === 'admin';
    detailsEl.innerHTML = `
        <h3 class="text-2xl font-bold">${p.username} (${p.is_online ? '<span class="text-green-400">Online</span>' : '<span class="text-red-400">Offline</span>'})</h3>
        <p class="text-gray-400">Role: ${p.role}</p>
        <div class="grid grid-cols-2 gap-4 mt-4">
            <div><label class="text-sm">Money</label><input id="edit-money" value="${p.money}" ${!canEditValues && 'disabled'} class="bg-gray-800 p-2 w-full rounded"></div>
            <div><label class="text-sm">Clicks</label><input id="edit-clicks" value="${p.clicks}" ${!canEditValues && 'disabled'} class="bg-gray-800 p-2 w-full rounded"></div>
            ${canEditValues ? `<button id="save-btn" class="col-span-2 bg-blue-600 p-2 rounded">Save Values</button>` : ''}
        </div>
        <hr class="my-4 border-gray-600">
        <h4 class="text-xl">Actions</h4>
        <div class="flex gap-2 mt-2 flex-wrap">
            <button id="chat-ban-btn" class="bg-yellow-600 p-2 rounded">${p.is_chat_banned ? 'Unban Chat' : 'Ban Chat'}</button>
            <input id="ban-hours" type="number" placeholder="Hours" class="bg-gray-800 p-2 w-24 rounded">
            <button id="temp-ban-btn" class="bg-orange-600 p-2 rounded">Temp Ban Server</button>
            <button id="perm-ban-btn" class="bg-red-700 p-2 rounded">Perm Ban Server</button>
        </div>
        <div class="mt-4"><button class="bg-gray-600 p-2 rounded" onclick="alert('This feature would allow editing game files like cases.json from a web interface.')">Manage Content</button></div>`;
    
    if (canEditValues) {
        document.getElementById('save-btn').onclick = async () => {
            const updates = { money: document.getElementById('edit-money').value, clicks: document.getElementById('edit-clicks').value };
            const res = await apiRequest('/api/admin/update_player', { username: gameState.username, target_user: username, updates });
            alert(res.message); showPlayerDetails(username);
        };
    }
    document.getElementById('chat-ban-btn').onclick = async () => {
        const res = await apiRequest('/api/admin/set_ban', { username: gameState.username, target_user: username, ban_type: 'chat' });
        alert(res.message); showPlayerDetails(username);
    };
    document.getElementById('temp-ban-btn').onclick = async () => {
        const hours = document.getElementById('ban-hours').value;
        if (!hours || hours <= 0) return alert('Enter a positive number of hours.');
        const res = await apiRequest('/api/admin/set_ban', { username: gameState.username, target_user: username, ban_type: 'server', duration_hours: hours });
        alert(res.message); showPlayerDetails(username);
    };
    document.getElementById('perm-ban-btn').onclick = async () => {
        if (confirm(`Are you absolutely sure you want to PERMANENTLY ban ${username}?`)) {
            const res = await apiRequest('/api/admin/set_ban', { username: gameState.username, target_user: username, ban_type: 'server' });
            alert(res.message); showPlayerDetails(username);
        }
    };
}

// --- Game Actions ---
async function handleLogin() {
    const username = document.getElementById('username-input').value;
    const password = document.getElementById('password-input').value;
    const response = await apiRequest('/api/login', { username, password });
    if (response.success) {
        gameState.username = username;
        gameState.playerData = response.player_data;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('game-container').classList.remove('hidden');
        if (['admin', 'moderator', 'helpdesk'].includes(response.player_data.role)) {
            document.getElementById('staff-panel-button').classList.remove('hidden');
        }
        // CRITICAL FIX: Ensure game data is loaded BEFORE first render
        await initializeGameData(); 
        updateStats();
        setupChatTabs();
        updateInterval = setInterval(updateLoop, 3000);
    }
}
async function handleOpenCase(caseName) {
    const modal = document.getElementById('unboxing-modal');
    modal.innerHTML = `<div class="text-white text-4xl">Opening...</div>`;
    modal.classList.add('active');
    const result = await apiRequest('/api/open_case', { username: gameState.username, case_name: caseName });
    if (result.success) {
        gameState.playerData = result.player_data;
        const item = result.item_won;
        modal.innerHTML = `
            <div class="bg-gray-800 border-4 border-cyan-400 rounded-lg p-8 text-center">
                <h2 class="text-2xl mb-4">You unboxed...</h2>
                <p class="text-3xl font-bold">${item.name}</p>
                <p class="text-lg text-green-300">$${item.value.toLocaleString()}</p>
                <button onclick="closeModal('unboxing-modal')" class="mt-6 bg-cyan-600 p-2 rounded w-full">Awesome!</button>
            </div>`;
    } else {
        alert(result.message);
        closeModal('unboxing-modal');
    }
}
async function handleSendChat() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;
    input.value = '';
    const body = { 
        username: gameState.username, 
        channel: gameState.activeChat.channel,
        message: message,
        receiver: gameState.activeChat.target
    };
    await apiRequest('/api/chat/send', body);
    updateLoop();
}

// --- Main Loop & Init ---
async function updateLoop() {
    if (!gameState.username) return;
    const response = await apiRequest('/api/game_state', { username: gameState.username });
    if (response.success) {
        gameState.playerData = response.player_data;
        gameState.onlinePlayers = response.online_players;
        gameState.chats = response.chats;
        updateStats();
        renderChatMessages();
    } else {
        clearInterval(updateInterval);
        alert("Session expired or connection lost. Please log in again.");
        location.reload();
    }
}
async function initializeGameData() {
    const [cases, skins, rarities, ranks] = await Promise.all([
        apiRequest('/api/game_data/cases', {}, 'GET'),
        apiRequest('/api/game_data/skins', {}, 'GET'),
        apiRequest('/api/game_data/rarities', {}, 'GET'),
        apiRequest('/api/game_data/ranks', {}, 'GET')
    ]);
    gameData = { cases, all_skins: skins, rarities, ranks };
}

// --- Event Listeners ---
window.addEventListener('load', () => {
    document.getElementById('login-button').onclick = handleLogin;
    document.getElementById('signup-button').onclick = async () => {
        const res = await apiRequest('/api/signup', {
            username: document.getElementById('username-input').value,
            password: document.getElementById('password-input').value
        });
        document.getElementById('login-error').textContent = res.message;
    };
    document.getElementById('logout-button').onclick = () => location.reload();
    document.getElementById('click-button').onclick = async () => {
        const res = await apiRequest('/api/click', {username: gameState.username});
        if(res.success) { gameState.playerData = res.player_data; updateStats(); }
    };
    document.getElementById('send-chat-button').onclick = handleSendChat;
    document.getElementById('chat-input').onkeyup = (e) => { if (e.key === 'Enter') handleSendChat(); };
    document.getElementById('staff-panel-button').onclick = () => openModal('staff-modal');
});
</script>

</body>
</html>

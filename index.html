<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Clicker Inc.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Arial', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chat-message { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .server-message { color: #00ffff; font-style: italic; }
        .player-message .sender { font-weight: bold; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        .skin-card { transition: all 0.2s ease-in-out; }
        .skin-card.selected { border-color: #00ffff; transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 255, 255, 0.5); }
        .tier-button { transition: background-color 0.2s; }
        .tier-button.active { background-color: #06b6d4; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-cyan-300 overflow-hidden h-screen">

    <div id="game-container" class="hidden w-full h-screen p-4 flex flex-col md:flex-row gap-4">
        <div class="flex-grow flex flex-col gap-4 w-full md:w-1/3">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <div class="flex justify-between items-center">
                    <h2 id="username-display" class="text-2xl font-bold text-white cursor-pointer hover:text-cyan-400" onclick="openModal('profile-modal')">Player</h2>
                    <button id="logout-button" class="bg-red-600 hover:bg-red-500 text-white text-sm font-bold py-1 px-3 rounded-lg">Logout</button>
                </div>
                <p class="text-lg">Rank: <span id="rank-stat" class="font-mono text-yellow-400"></span></p>
                <div class="grid grid-cols-2 gap-2 mt-2 text-lg">
                    <p>üí∞ Money: <span id="money-stat" class="font-mono text-green-400">0</span></p>
                    <p>üñ±Ô∏è Clicks: <span id="clicks-stat" class="font-mono text-yellow-400">0</span></p>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col items-center justify-center">
                <button id="click-button" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold text-4xl py-16 px-24 rounded-full transition-transform transform hover:scale-105 active:scale-95 shadow-2xl">Click!</button>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-8 w-full">
                    <button onclick="openModal('shop-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Shop</button>
                    <button onclick="openModal('inventory-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Inventory</button>
                    <button onclick="openModal('leaderboard-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Leaders</button>
                    <button id="staff-panel-button" class="hidden bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 rounded-lg">Staff</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-4 w-full md:w-2/3 h-full">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col h-1/2">
                <h3 class="text-xl font-bold text-white mb-2 border-b border-gray-700 pb-2">Global Chat</h3>
                <div id="chat-box" class="flex-grow overflow-y-auto mb-2 pr-2 space-y-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow bg-gray-700 text-white rounded-lg p-2" placeholder="Type a message...">
                    <button id="send-chat-button" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="login-screen" class="w-full h-screen flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <h1 class="text-4xl font-bold text-white mb-6">Case Clicker Inc.</h1>
            <div class="space-y-4">
                <input type="text" id="username-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center text-lg" placeholder="Enter Username" autocomplete="username">
                <input type="password" id="password-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center text-lg" placeholder="Enter Password" autocomplete="current-password">
            </div>
            <div class="flex gap-4 mt-6">
                <button id="login-button" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg text-lg">Login</button>
                <button id="signup-button" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg text-lg">Sign Up</button>
            </div>
             <div class="mt-4 text-left flex items-center justify-between">
                <div>
                    <input type="checkbox" id="remember-me" class="bg-gray-700 rounded">
                    <label for="remember-me" class="text-gray-400 ml-2">Remember me</label>
                </div>
                <div>
                    <input type="checkbox" id="show-password" class="bg-gray-700 rounded">
                    <label for="show-password" class="text-gray-400 ml-2">Show Password</label>
                </div>
            </div>
            <p id="login-error" class="text-red-400 mt-4 h-6"></p>
        </div>
    </div>
    
    <div id="shop-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-20">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-6xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-2xl text-white font-bold">Case Shop</h2>
                <div class="flex items-center gap-4">
                    <span class="text-lg text-green-400 font-mono">üí∞ <span id="shop-money-display">0</span></span>
                    <select id="shop-sort" class="bg-gray-700 text-white rounded p-2">
                        <option value="lth">Price: Low to High</option>
                        <option value="htl">Price: High to Low</option>
                    </select>
                    <button onclick="closeModal('shop-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
            </div>
            <div id="shop-tier-buttons" class="flex flex-wrap gap-2 p-2 overflow-x-auto">
            </div>
            <div id="shop-case-list" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-2"></div>
        </div>
    </div>

    <div id="profile-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-40">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-md flex flex-col p-6">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h2 class="text-2xl text-white font-bold">Manage Profile</h2>
                <button onclick="closeModal('profile-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-400 mb-1">Change Username (1 time only)</label>
                    <input type="text" id="new-username-input" class="w-full bg-gray-700 text-white rounded-lg p-3" placeholder="Enter new username">
                </div>
                <div>
                    <label class="block text-gray-400 mb-1">Change Password (1 time only)</label>
                    <input type="password" id="new-password-input" class="w-full bg-gray-700 text-white rounded-lg p-3" placeholder="Enter new password">
                </div>
                <hr class="border-gray-600">
                <div>
                    <label class="block text-gray-400 mb-1">Current Password (Required to save)</label>
                    <input type="password" id="current-password-input" class="w-full bg-gray-700 text-white rounded-lg p-3" placeholder="Enter current password">
                </div>
            </div>
            <p id="profile-message" class="text-center h-6 mt-4"></p>
            <button id="save-profile-button" class="w-full mt-4 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg text-lg">Save Changes</button>
        </div>
    </div>

    <div id="inventory-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-20">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-6xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-2xl text-white font-bold">Inventory</h2>
                <button onclick="closeModal('inventory-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex flex-grow overflow-hidden gap-4">
                <div class="w-1/3 flex flex-col">
                    <h3 class="text-xl font-bold text-white mb-2">My Cases</h3>
                    <div id="inventory-case-list" class="flex-grow overflow-y-auto bg-gray-900 p-2 rounded-lg"></div>
                </div>
                <div class="w-2/3 flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-white">My Skins (<span id="skin-count">0</span>)</h3>
                        <div id="sell-button-container" class="hidden">
                            <button id="sell-selected-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Sell Selected (0)</button>
                        </div>
                    </div>
                    <div id="inventory-skin-list" class="flex-grow overflow-y-auto bg-gray-900 p-2 rounded-lg grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
                </div>
            </div>
        </div>
    </div>
    
     <div id="leaderboard-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-20">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-5xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                <h2 class="text-2xl text-white font-bold">Leaderboards</h2>
                <button onclick="closeModal('leaderboard-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="leaderboard-content" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <div id="staff-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-30">
        <div id="admin-panel-content" class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-7xl h-5/6 flex flex-col p-4">
             </div>
    </div>

    <div id="unboxing-modal" class="modal fixed inset-0 bg-black bg-opacity-85 items-center justify-center z-50">
        <div id="unboxing-result" class="bg-gray-800 border-4 rounded-lg shadow-2xl w-full max-w-md text-center p-8 transform transition-all duration-500 scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-white mb-4">You unboxed...</h2>
            <div id="unboxed-item-card" class="p-4 rounded-lg">
                <p id="unboxed-item-name" class="text-3xl font-bold"></p>
                <p class="text-lg text-gray-400">Value: <span id="unboxed-item-value" class="font-mono text-green-300"></span></p>
            </div>
            <button onclick="closeModal('unboxing-modal')" class="mt-6 w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg">Awesome!</button>
        </div>
    </div>


<script>
// --- Client-Side Game Logic ---
const API_URL = window.location.origin;

// --- State Management ---
let gameState = {
    username: null,
    playerData: { role: 'player', clicks: 0, money: 0, skins: [], cases: {}, rank: 0 },
    onlinePlayers: [],
    lastGlobalChatId: '0',
    selectedSkinIds: new Set(),
};
let gameData = { cases: {}, skins: {}, rarities: {}, ranks: {} };
let updateInterval;
let shopState = { tier: 1, sort: 'lth' };

// --- DOM Elements ---
const loginScreen = document.getElementById('login-screen');
const gameContainer = document.getElementById('game-container');
const usernameInput = document.getElementById('username-input');
const passwordInput = document.getElementById('password-input');
const loginButton = document.getElementById('login-button');
const signupButton = document.getElementById('signup-button');
const rememberMe = document.getElementById('remember-me');
const showPassword = document.getElementById('show-password');
const loginError = document.getElementById('login-error');
const usernameDisplay = document.getElementById('username-display');
const moneyStat = document.getElementById('money-stat');
const clicksStat = document.getElementById('clicks-stat');
const rankStat = document.getElementById('rank-stat');
const clickButton = document.getElementById('click-button');
const chatBox = document.getElementById('chat-box');
const chatInput = document.getElementById('chat-input');
const sendChatButton = document.getElementById('send-chat-button');
const shopCaseList = document.getElementById('shop-case-list');
const inventoryCaseList = document.getElementById('inventory-case-list');
const inventorySkinList = document.getElementById('inventory-skin-list');
const skinCount = document.getElementById('skin-count');
const sellButtonContainer = document.getElementById('sell-button-container');
const sellSelectedBtn = document.getElementById('sell-selected-btn');
const staffPanelButton = document.getElementById('staff-panel-button');
const adminPanelContent = document.getElementById('admin-panel-content');
const leaderboardContent = document.getElementById('leaderboard-content');
const logoutButton = document.getElementById('logout-button');
const shopMoneyDisplay = document.getElementById('shop-money-display');
const shopSort = document.getElementById('shop-sort');
const shopTierButtons = document.getElementById('shop-tier-buttons');
const newUsernameInput = document.getElementById('new-username-input');
const newPasswordInput = document.getElementById('new-password-input');
const currentPasswordInput = document.getElementById('current-password-input');
const saveProfileButton = document.getElementById('save-profile-button');
const profileMessage = document.getElementById('profile-message');

// --- Helper Functions ---
function formatNumber(num) {
    if (num === null || num === undefined) return '0';
    const suffixes = ['', 'K', 'M', 'B', 'T', 'q', 'Q', 's', 'S'];
    if (num < 1000) return Math.floor(num).toLocaleString();
    const i = Math.floor(Math.log10(num) / 3);
    const shortNum = (num / Math.pow(1000, i)).toFixed(2);
    return shortNum + suffixes[i];
}

function getRarityStyle(skinName) {
    const rarityName = gameData.skins[skinName];
    if (rarityName && gameData.rarities[rarityName]) {
        const color = gameData.rarities[rarityName].color;
        const colorMap = {
            "gray": "border-gray-400 text-gray-300", "light blue": "border-cyan-400 text-cyan-300",
            "blue": "border-blue-500 text-blue-400", "purple": "border-purple-500 text-purple-400",
            "orange": "border-orange-500 text-orange-400", "red": "border-red-500 text-red-400",
        };
        return colorMap[color] || 'border-gray-400';
    }
    return 'border-gray-400';
}

// --- API Helper ---
async function apiRequest(endpoint, body = {}, method = 'POST') {
    try {
        const options = {
            method: method,
            headers: { 'Content-Type': 'application/json' },
        };
        if (method !== 'GET' && Object.keys(body).length > 0) {
            options.body = JSON.stringify(body);
        }
        const response = await fetch(`${API_URL}${endpoint}`, options);
        const text = await response.text();
        if (!response.ok) {
             throw new Error(text || `HTTP error! status: ${response.status}`);
        }
        if (!text) {
            return { success: true };
        }
        const data = JSON.parse(text);
        return data;
    } catch (error) {
        console.error(`API request to ${endpoint} failed:`, error);
        try {
            const jsonData = JSON.parse(error.message);
            if (endpoint.includes('login') || endpoint.includes('signup')) {
                loginError.textContent = jsonData.message;
            }
            return { success: false, message: jsonData.message };
        } catch(e) {
             if (endpoint.includes('login') || endpoint.includes('signup')) {
                loginError.textContent = "An unexpected server error occurred.";
            }
        }
        return { success: false, message: error.message };
    }
}

// --- Modals ---
function openModal(modalId) {
    if (modalId === 'staff-modal') {
        if (['admin', 'moderator', 'helpdesk'].includes(gameState.playerData.role)) {
            renderAdminPanel();
        }
    }
    if (modalId === 'leaderboard-modal') renderLeaderboards();
    if (modalId === 'shop-modal') renderShop();
    if (modalId === 'profile-modal') prepareProfileModal();
    document.getElementById(modalId).classList.add('active');
}
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// --- UI Update Functions ---
function updateStats() {
    const player = gameState.playerData;
    moneyStat.textContent = `$${formatNumber(player.money)}`;
    clicksStat.textContent = formatNumber(player.clicks);
    const rank = gameData.ranks[player.rank] || {name: 'Unranked'};
    rankStat.textContent = rank.name;
    shopMoneyDisplay.textContent = formatNumber(player.money);
}

function updateChat(messages) {
    if (messages.length === 0) return;
    const shouldScroll = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 20;

    messages.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';
        if (msg.is_server_msg) {
            return;
        } else {
            msgDiv.classList.add('player-message');
            const senderSpan = document.createElement('span');
            senderSpan.className = 'sender';
            senderSpan.textContent = `${msg.sender}: `;
            if (msg.sender === gameState.username) senderSpan.style.color = '#67e8f9';
            
            const msgSpan = document.createElement('span');
            msgSpan.textContent = msg.msg;

            msgDiv.appendChild(senderSpan);
            msgDiv.appendChild(msgSpan);
        }
        chatBox.appendChild(msgDiv);
        gameState.lastGlobalChatId = msg.id;
    });

    if (shouldScroll) chatBox.scrollTop = chatBox.scrollHeight;
}

function renderShop() {
    shopCaseList.innerHTML = '';
    let cases = Object.entries(gameData.cases)
        .filter(([, caseInfo]) => caseInfo.tier === shopState.tier);

    if (shopState.sort === 'htl') {
        cases.sort(([,a],[,b]) => parseFloat(b.price) - parseFloat(a.price));
    } else {
        cases.sort(([,a],[,b]) => parseFloat(a.price) - parseFloat(b.price));
    }

    cases.forEach(([name, caseInfo]) => {
        const caseDiv = document.createElement('div');
        caseDiv.className = 'bg-gray-700 p-4 rounded-lg flex flex-col justify-between';
        caseDiv.innerHTML = `
            <div>
                <h4 class="text-lg font-bold text-white truncate">${name}</h4>
                <p class="text-green-400 font-mono">$${formatNumber(caseInfo.price)}</p>
            </div>
            <div class="flex gap-2 mt-4">
                 <input type="number" value="1" min="1" max="100" class="w-16 bg-gray-800 text-white p-1 rounded text-center" id="buy-qty-${name.replace(/[^a-zA-Z0-9]/g, '')}">
                 <button class="flex-grow bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-3 rounded-lg">Buy</button>
            </div>
        `;
        caseDiv.querySelector('button').addEventListener('click', async () => {
            const quantity = document.getElementById(`buy-qty-${name.replace(/[^a-zA-Z0-9]/g, '')}`).value;
            const result = await apiRequest('/api/buy_case', { username: gameState.username, case_name: name, quantity: quantity });
            if (result.success) {
                gameState.playerData = result.player_data;
                updateStats();
                updateInventory();
            } else {
                alert(result.message || "Failed to buy case.");
            }
        });
        shopCaseList.appendChild(caseDiv);
    });
}

function setupShopControls() {
    shopTierButtons.innerHTML = '';
    // Assuming max tier is 20, adjust if needed
    for(let i = 1; i <= 20; i++) {
        const button = document.createElement('button');
        button.className = `tier-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg`;
        button.textContent = `T${i}`;
        if (i === shopState.tier) button.classList.add('active');
        button.addEventListener('click', () => {
            shopState.tier = i;
            document.querySelectorAll('.tier-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            renderShop();
        });
        shopTierButtons.appendChild(button);
    }
    shopSort.addEventListener('change', (e) => {
        shopState.sort = e.target.value;
        renderShop();
    });
}

function updateInventory() {
    inventoryCaseList.innerHTML = '';
    const ownedCases = gameState.playerData.cases || {};
    Object.entries(ownedCases).sort(([a],[b])=>a.localeCompare(b)).forEach(([name, count]) => {
        if (count > 0) {
            const caseDiv = document.createElement('div');
            caseDiv.className = 'bg-gray-700 p-3 rounded-lg mb-2 flex justify-between items-center';
            caseDiv.innerHTML = `<div><h5 class="text-white font-bold">${name}</h5><p class="text-gray-400">Owned: ${count}</p></div><button class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Open</button>`;
            caseDiv.querySelector('button').addEventListener('click', () => handleOpenCase(name));
            inventoryCaseList.appendChild(caseDiv);
        }
    });

    inventorySkinList.innerHTML = '';
    const sortedSkins = (gameState.playerData.skins || []).sort((a,b) => b.value - a.value);
    skinCount.textContent = sortedSkins.length;

    sortedSkins.forEach(skin => {
        const skinDiv = document.createElement('div');
        skinDiv.className = `skin-card bg-gray-800 p-2 rounded-lg border-2 border-transparent cursor-pointer ${getRarityStyle(skin.name)}`;
        skinDiv.dataset.skinId = skin.id;
        skinDiv.innerHTML = `<p class="font-bold text-sm truncate">${skin.name}</p><p class="text-xs text-green-400 font-mono">$${formatNumber(skin.value)}</p>`;
        if (gameState.selectedSkinIds.has(skin.id)) skinDiv.classList.add('selected');

        skinDiv.addEventListener('click', () => {
            gameState.selectedSkinIds.has(skin.id) ? gameState.selectedSkinIds.delete(skin.id) : gameState.selectedSkinIds.add(skin.id);
            skinDiv.classList.toggle('selected');
            updateSellButton();
        });
        inventorySkinList.appendChild(skinDiv);
    });
    updateSellButton();
}

function updateSellButton() {
    const selectedCount = gameState.selectedSkinIds.size;
    if (selectedCount > 0) {
        let totalValue = 0;
        const skins = gameState.playerData.skins || [];
        for (const id of gameState.selectedSkinIds) {
            const skin = skins.find(s => s.id === id);
            if(skin) totalValue += skin.value;
        }
        sellSelectedBtn.textContent = `Sell Selected (${selectedCount}) for $${formatNumber(Math.floor(totalValue))}`;
        sellButtonContainer.classList.remove('hidden');
    } else {
        sellButtonContainer.classList.add('hidden');
    }
}

// --- Game Actions ---
async function handleLogin() {
    const user = usernameInput.value.trim();
    const pass = passwordInput.value;
    if (!user || !pass) {
        loginError.textContent = 'Username and password are required.';
        return;
    }
    loginError.textContent = '';
    loginButton.disabled = true;
    loginButton.textContent = '...';

    const response = await apiRequest('/api/login', { username: user, password: pass });

    loginButton.disabled = false;
    loginButton.textContent = 'Login';

    if (response.success) {
        gameState.username = user;
        gameState.playerData = response.player_data;
        if (rememberMe.checked) {
            localStorage.setItem('rememberedUsername', user);
        } else {
            localStorage.removeItem('rememberedUsername');
        }
        
        loginScreen.classList.add('hidden');
        gameContainer.classList.remove('hidden');
        usernameDisplay.textContent = user;
        
        staffPanelButton.textContent = gameState.playerData.role === 'admin' ? 'Admin Panel' : 'Staff Panel';
        if (['admin', 'moderator', 'helpdesk'].includes(gameState.playerData.role)) {
            staffPanelButton.classList.remove('hidden');
        }
        
        await initializeGameData();
        updateStats();
        updateInventory();
        setupShopControls();

        updateLoop();
        updateInterval = setInterval(updateLoop, 2000);
    } else {
        loginError.textContent = response.message || 'Login failed.';
    }
}

async function handleSignup() {
    const user = usernameInput.value.trim();
    const pass = passwordInput.value;
    if (!user || !pass) {
        loginError.textContent = 'Username and password are required.';
        return;
    }
    loginError.textContent = '';
    signupButton.disabled = true;
    signupButton.textContent = '...';

    const response = await apiRequest('/api/signup', { username: user, password: pass });
    
    signupButton.disabled = false;
    signupButton.textContent = 'Sign Up';

    if (response.success) {
        loginError.textContent = response.message; 
    } else {
        loginError.textContent = response.message || 'Sign up failed.';
    }
}

function handleLogout() {
    clearInterval(updateInterval);
    gameState = { username: null, playerData: {}, onlinePlayers: [], lastGlobalChatId: '0', selectedSkinIds: new Set() };
    gameContainer.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    passwordInput.value = '';
    staffPanelButton.classList.add('hidden');
}

async function handleSendChat() {
    const message = chatInput.value.trim();
    if (!message) return;
    chatInput.value = '';
    const result = await apiRequest('/api/chat/global', { username: gameState.username, message: message });
    if (!result.success) {
        alert(result.message);
    }
}

async function handleOpenCase(caseName) {
    const result = await apiRequest('/api/open_case', { username: gameState.username, case_name: caseName });
    if (result.success) {
        gameState.playerData = result.player_data;
        updateStats();
        updateInventory();
        
        const item = result.item_won;
        const rarityStyle = getRarityStyle(item.name);
        document.getElementById('unboxed-item-name').textContent = item.name;
        document.getElementById('unboxed-item-name').className = `text-3xl font-bold ${rarityStyle.split(' ')[1]}`;
        document.getElementById('unboxed-item-value').textContent = `$${formatNumber(item.value)}`;
        document.getElementById('unboxed-item-card').className = `p-4 rounded-lg border-2 ${rarityStyle.split(' ')[0]}`;
        
        openModal('unboxing-modal');
        setTimeout(() => {
           document.getElementById('unboxing-result').classList.remove('scale-95', 'opacity-0');
           document.getElementById('unboxing-result').classList.add('scale-100', 'opacity-100');
        }, 50);

    } else {
        alert(result.message || "Failed to open case.");
    }
}

async function handleSellSkins() {
    if (gameState.selectedSkinIds.size === 0) return;
    const ids = Array.from(gameState.selectedSkinIds);
    const result = await apiRequest('/api/sell_skins', {username: gameState.username, skin_ids: ids});

    if (result.success) {
        gameState.playerData = result.player_data;
        gameState.selectedSkinIds.clear();
        updateStats();
        updateInventory();
    } else {
        alert("Failed to sell skins.");
    }
}

function prepareProfileModal() {
    newUsernameInput.value = '';
    newPasswordInput.value = '';
    currentPasswordInput.value = '';
    profileMessage.textContent = '';
    profileMessage.className = 'text-center h-6 mt-4';
    newUsernameInput.disabled = gameState.playerData.has_changed_username;
    if(newUsernameInput.disabled) newUsernameInput.placeholder = "Username already changed";
    newPasswordInput.disabled = gameState.playerData.has_changed_password;
    if(newPasswordInput.disabled) newPasswordInput.placeholder = "Password already changed";
}

async function handleSaveProfile() {
    const current_password = currentPasswordInput.value;
    const new_username = newUsernameInput.value.trim();
    const new_password = newPasswordInput.value.trim();
    if (!current_password) {
        profileMessage.textContent = 'Current password is required.';
        profileMessage.className = 'text-center h-6 mt-4 text-red-400';
        return;
    }
    if (!new_username && !new_password) {
        profileMessage.textContent = 'Enter a new username or password.';
        profileMessage.className = 'text-center h-6 mt-4 text-red-400';
        return;
    }
    const body = {
        username: gameState.username,
        current_password: current_password,
        new_username: new_username || null,
        new_password: new_password || null,
    };
    const result = await apiRequest('/api/update_profile', body);
    if (result.success) {
        profileMessage.textContent = result.message;
        profileMessage.className = 'text-center h-6 mt-4 text-green-400';
        if (result.new_username) {
            alert("Username changed! You will be logged out.");
            handleLogout();
        }
    } else {
        profileMessage.textContent = result.message;
        profileMessage.className = 'text-center h-6 mt-4 text-red-400';
    }
}


// --- Leaderboards ---
async function renderLeaderboards() {
    const data = await apiRequest('/api/leaderboards', {}, 'GET');
    leaderboardContent.innerHTML = '';
    const boardTitles = {
        most_clicks: "Most Clicks", most_money: "Richest Players", most_time_played: "Most Time Played",
        most_money_spent: "Biggest Spenders", inventory_value: "Highest Inventory Value", highest_skin_value: "Most Valuable Skin",
        most_cases_opened: "Most Cases Opened", monthly_clicks: "Clicks This Month", monthly_cases_opened: "Cases Opened This Month"
    };
    for (const [key, board] of Object.entries(boardTitles)) {
        const boardData = data[key] || [];
        const boardDiv = document.createElement('div');
        boardDiv.className = 'bg-gray-700 p-3 rounded-lg';
        let listHtml = `<h4 class="text-white font-bold text-lg mb-2">${board}</h4><ol class="list-decimal list-inside space-y-1">`;
        boardData.forEach(p => { 
            listHtml += `<li class="truncate">${p.username} - <span class="font-mono text-green-300">${formatNumber(Math.floor(p.value))}</span></li>`;
        });
        listHtml += '</ol>';
        boardDiv.innerHTML = listHtml;
        leaderboardContent.appendChild(boardDiv);
    }
}

// --- Admin/Staff Panels ---
async function renderAdminPanel() {
    adminPanelContent.innerHTML = `
        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
            <h2 class="text-2xl text-white font-bold">Admin Panel</h2>
            <button onclick="closeModal('staff-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="flex flex-grow overflow-hidden gap-4 h-full">
            <div class="w-1/3 flex flex-col h-full">
                <input type="text" id="player-search-input" placeholder="Search players..." class="w-full bg-gray-900 p-2 rounded mb-2">
                <div id="admin-player-list" class="flex-grow overflow-y-auto bg-gray-900 p-2 rounded-lg"></div>
            </div>
            <div id="admin-player-details" class="w-2/3 bg-gray-900 p-4 rounded-lg overflow-y-auto">
                Select a player to view their details.
            </div>
        </div>`;
    
    const allPlayersData = await apiRequest('/api/admin/all_players', {username: gameState.username});
    const playerListContainer = document.getElementById('admin-player-list');
    const allPlayers = Object.entries(allPlayersData).filter(([name]) => !name.startsWith("AI_"));

    function displayPlayers(players) {
        playerListContainer.innerHTML = '';
        players.sort(([a],[b])=> a.localeCompare(b)).forEach(([username, data]) => {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'p-2 hover:bg-gray-700 cursor-pointer rounded';
            playerDiv.textContent = username;
            playerDiv.dataset.username = username;
            playerDiv.onclick = () => showPlayerDetails(username);
            playerListContainer.appendChild(playerDiv);
        });
    }

    displayPlayers(allPlayers);

    document.getElementById('player-search-input').addEventListener('keyup', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredPlayers = allPlayers.filter(([name]) => name.toLowerCase().includes(searchTerm));
        displayPlayers(filteredPlayers);
    });
}

async function showPlayerDetails(username) {
    const detailsContainer = document.getElementById('admin-player-details');
    detailsContainer.innerHTML = 'Loading...';
    const response = await apiRequest(`/api/admin/player/${username}`, {}, 'GET');
    if (!response.success) {
        detailsContainer.innerHTML = 'Could not load player details.';
        return;
    }
    const player = response.player;
    const onlineStatus = player.is_online ? '<span class="text-green-400">Online</span>' : '<span class="text-red-400">Offline</span>';
    detailsContainer.innerHTML = `
        <h3 class="text-2xl font-bold">${username} (${onlineStatus})</h3>
        <p class="text-gray-400">Role: ${player.role}</p>
        <div class="grid grid-cols-2 gap-4 mt-4">
            <div><label class="block text-gray-400">Money</label><input type="text" id="edit-money" value="${player.money}" class="bg-gray-800 p-2 rounded w-full"></div>
            <div><label class="block text-gray-400">Clicks</label><input type="text" id="edit-clicks" value="${player.clicks}" class="bg-gray-800 p-2 rounded w-full"></div>
            <div><label class="block text-gray-400">Rank #</label><input type="text" id="edit-rank" value="${player.rank}" class="bg-gray-800 p-2 rounded w-full"></div>
            <button id="save-player-details" class="col-span-2 bg-blue-600 hover:bg-blue-500 text-white font-bold p-2 rounded">Save Values</button>
        </div>
        <hr class="my-4 border-gray-600">
        <h4 class="text-xl font-bold">Actions</h4>
        <div class="flex gap-2 mt-2 flex-wrap">
            <button id="chat-ban-btn" class="flex-grow bg-yellow-600 p-2 rounded">${player.is_chat_banned ? "Unban Chat" : "Ban Chat"}</button>
            <input type="number" id="temp-ban-duration" placeholder="Hours" class="bg-gray-800 p-2 rounded w-24">
            <button id="temp-ban-btn" class="bg-orange-600 p-2 rounded">Temp Ban</button>
            <button id="perm-ban-btn" class="bg-red-700 p-2 rounded">PERMA BAN</button>
        </div>
        <hr class="my-4 border-gray-600">
        <h4 class="text-xl font-bold">Private Message</h4>
        <textarea id="private-message-input" class="w-full bg-gray-800 p-2 rounded mt-2" rows="3"></textarea>
        <button id="send-pm-btn" class="bg-purple-600 w-full p-2 rounded mt-2">Send Message</button>
    `;

    document.getElementById('save-player-details').onclick = async () => {
        const updates = {
            money: document.getElementById('edit-money').value,
            clicks: document.getElementById('edit-clicks').value,
            rank: document.getElementById('edit-rank').value,
        };
        const res = await apiRequest('/api/admin/update_player', { username: gameState.username, target_user: username, updates: updates });
        alert(res.message);
        showPlayerDetails(username);
    };

    document.getElementById('chat-ban-btn').onclick = async () => {
        const res = await apiRequest('/api/helpdesk/set_chat_ban', { username: gameState.username, target_user: username, is_banned: !player.is_chat_banned });
        alert(res.message);
        showPlayerDetails(username);
    };
    
    document.getElementById('temp-ban-btn').onclick = async () => {
        const hours = document.getElementById('temp-ban-duration').value;
        if (!hours || hours <= 0) { alert("Please enter a valid number of hours."); return; }
        const res = await apiRequest('/api/admin/ban_player', { username: gameState.username, target_user: username, duration_seconds: hours * 3600 });
        alert(res.message);
    };

    document.getElementById('perm-ban-btn').onclick = async () => {
        if (!confirm(`Are you sure you want to permanently ban ${username}?`)) return;
        const res = await apiRequest('/api/admin/ban_player', { username: gameState.username, target_user: username, duration_seconds: null });
        alert(res.message);
    };

    document.getElementById('send-pm-btn').onclick = async () => {
        const message = document.getElementById('private-message-input').value;
        if (!message) { alert("Message cannot be empty."); return; }
        const res = await apiRequest('/api/admin/private_message', { username: gameState.username, target_user: username, message: message });
        alert(res.message);
        document.getElementById('private-message-input').value = '';
    };
}

// --- Main Game Loop ---
async function updateLoop() {
    if (!gameState.username) return;
    const response = await apiRequest('/api/game_state', { username: gameState.username, last_chat_id: gameState.lastGlobalChatId });
    if (response.success) {
        gameState.playerData = response.player_data;
        gameState.onlinePlayers = response.online_players;
        updateStats();
        updateChat(response.new_global_messages);
    } else {
        alert("Connection to server lost. Please log in again.");
        handleLogout();
    }
}

async function initializeGameData() {
    const [cases, skins, rarities, ranks] = await Promise.all([
        apiRequest('/api/game_data/cases', {}, 'GET'),
        apiRequest('/api/game_data/skins', {}, 'GET'),
        apiRequest('/api/game_data/rarities', {}, 'GET'),
        apiRequest('/api/game_data/ranks', {}, 'GET')
    ]);
    gameData = { cases, skins, rarities, ranks };
}

// --- Event Listeners ---
window.addEventListener('load', () => {
    const rememberedUser = localStorage.getItem('rememberedUsername');
    if (rememberedUser) {
        usernameInput.value = rememberedUser;
        rememberMe.checked = true;
    }

    loginButton.addEventListener('click', handleLogin);
    signupButton.addEventListener('click', handleSignup);
    passwordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });
    logoutButton.addEventListener('click', handleLogout);
    saveProfileButton.addEventListener('click', handleSaveProfile);
    staffPanelButton.addEventListener('click', () => openModal('staff-modal'));
    showPassword.addEventListener('change', () => {
        passwordInput.type = showPassword.checked ? 'text' : 'password';
    });

    clickButton.addEventListener('click', async () => {
        const result = await apiRequest('/api/click', { username: gameState.username });
        if (result.success) {
            gameState.playerData = result.player_data;
            updateStats();
        }
    });

    sendChatButton.addEventListener('click', handleSendChat);
    chatInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSendChat(); });

    sellSelectedBtn.addEventListener('click', handleSellSkins);
});
</script>

</body>
</html>

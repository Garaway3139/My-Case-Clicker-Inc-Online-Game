<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Clicker Inc.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Arial', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chat-message { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .server-message { color: #00ffff; font-style: italic; }
        .player-message .sender { font-weight: bold; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        .skin-card { transition: all 0.2s ease-in-out; }
        .skin-card.selected { border-color: #00ffff; transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 255, 255, 0.5); }
        .tab-button.active { background-color: #0891b2; color: white; }
        .tier-button { transition: background-color 0.2s; }
        .tier-button.active { background-color: #06b6d4; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-cyan-300 overflow-hidden h-screen">

    <div id="game-container" class="hidden w-full h-screen p-4 flex flex-col md:flex-row gap-4">
        <div class="flex-grow flex flex-col gap-4 w-full md:w-1/3">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <div class="flex justify-between items-center">
                    <h2 id="username-display" class="text-2xl font-bold text-white cursor-pointer hover:text-cyan-400" onclick="openModal('profile-modal')">Player</h2>
                    <button id="logout-button" class="bg-red-600 hover:bg-red-500 text-white text-sm font-bold py-1 px-3 rounded-lg">Logout</button>
                </div>
                <p class="text-lg">Rank: <span id="rank-stat" class="font-mono text-yellow-400"></span></p>
                <div class="grid grid-cols-2 gap-2 mt-2 text-lg">
                    <p>üí∞ Money: <span id="money-stat" class="font-mono text-green-400">0</span></p>
                    <p>üñ±Ô∏è Clicks: <span id="clicks-stat" class="font-mono text-yellow-400">0</span></p>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col items-center justify-center">
                <button id="click-button" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold text-4xl py-16 px-24 rounded-full transition-transform transform hover:scale-105 active:scale-95 shadow-2xl">Click!</button>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-8 w-full">
                    <button onclick="openModal('shop-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Shop</button>
                    <button onclick="openModal('inventory-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Inventory</button>
                    <button onclick="openModal('leaderboard-modal')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Leaders</button>
                    <button id="staff-panel-button" onclick="openModal('staff-modal')" class="hidden bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 rounded-lg">Staff</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-4 w-full md:w-2/3 h-full">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col h-1/2">
                <h3 class="text-xl font-bold text-white mb-2 border-b border-gray-700 pb-2">Global Chat</h3>
                <div id="chat-box" class="flex-grow overflow-y-auto mb-2 pr-2 space-y-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow bg-gray-700 text-white rounded-lg p-2" placeholder="Type a message...">
                    <button id="send-chat-button" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="login-screen" class="w-full h-screen flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
            <h1 class="text-4xl font-bold text-white mb-6">Case Clicker IncV2.</h1>
            <div class="space-y-4">
                <input type="text" id="username-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center text-lg" placeholder="Enter Username" autocomplete="username">
                <input type="password" id="password-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center text-lg" placeholder="Enter Password" autocomplete="current-password">
            </div>
            <div class="flex gap-4 mt-6">
                <button id="login-button" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg text-lg">Login</button>
                <button id="signup-button" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg text-lg">Sign Up</button>
            </div>
             <div class="mt-4 text-left flex items-center justify-between">
                <div>
                    <input type="checkbox" id="remember-me" class="bg-gray-700 rounded">
                    <label for="remember-me" class="text-gray-400 ml-2">Remember me</label>
                </div>
                <div>
                    <input type="checkbox" id="show-password" class="bg-gray-700 rounded">
                    <label for="show-password" class="text-gray-400 ml-2">Show Password</label>
                </div>
            </div>
            <p id="login-error" class="text-red-400 mt-4 h-6"></p>
        </div>
    </div>
    
    <div id="shop-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-20">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-6xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-2xl text-white font-bold">Case Shop</h2>
                <div class="flex items-center gap-4">
                    <span class="text-lg text-green-400 font-mono">üí∞ <span id="shop-money-display">0</span></span>
                    <select id="shop-sort" class="bg-gray-700 text-white rounded p-2">
                        <option value="lth">Price: Low to High</option>
                        <option value="htl">Price: High to Low</option>
                    </select>
                    <button onclick="closeModal('shop-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
            </div>
            <div id="shop-tier-buttons" class="flex flex-wrap gap-2 p-2 overflow-x-auto">
            </div>
            <div id="shop-case-list" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-2"></div>
        </div>
    </div>
    <div id="profile-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-40">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-md flex flex-col p-6">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h2 class="text-2xl text-white font-bold">Manage Profile</h2>
                <button onclick="closeModal('profile-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <p class="text-center text-gray-400">Profile management coming soon!</p>
        </div>
    </div>
    <div id="inventory-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-20">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-6xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                <h2 class="text-2xl text-white font-bold">Inventory</h2>
                <button onclick="closeModal('inventory-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex flex-grow overflow-hidden gap-4">
                <div class="w-1/3 flex flex-col">
                    <h3 class="text-xl font-bold text-white mb-2">My Cases</h3>
                    <div id="inventory-case-list" class="flex-grow overflow-y-auto bg-gray-900 p-2 rounded-lg"></div>
                </div>
                <div class="w-2/3 flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-white">My Skins (<span id="skin-count">0</span>)</h3>
                        <div id="sell-button-container" class="hidden">
                            <button id="sell-selected-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Sell Selected (0)</button>
                        </div>
                    </div>
                    <div id="inventory-skin-list" class="flex-grow overflow-y-auto bg-gray-900 p-2 rounded-lg grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
                </div>
            </div>
        </div>
    </div>
     <div id="leaderboard-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-20">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-5xl h-5/6 flex flex-col p-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                <h2 class="text-2xl text-white font-bold">Leaderboards</h2>
                <button onclick="closeModal('leaderboard-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="leaderboard-content" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>
    <div id="staff-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-30">
        <div id="admin-panel-content" class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-7xl h-5/6 flex-col p-4">
            <p class="text-center text-gray-400">Admin panel coming soon!</p>
            <button onclick="closeModal('staff-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
    </div>
    <div id="unboxing-modal" class="modal fixed inset-0 bg-black bg-opacity-85 items-center justify-center z-50">
        <div id="unboxing-result" class="bg-gray-800 border-4 rounded-lg shadow-2xl w-full max-w-md text-center p-8 transform transition-all duration-500 scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-white mb-4">You unboxed...</h2>
            <div id="unboxed-item-card" class="p-4 rounded-lg">
                <p id="unboxed-item-name" class="text-3xl font-bold"></p>
                <p class="text-lg text-gray-400">Value: <span id="unboxed-item-value" class="font-mono text-green-300"></span></p>
            </div>
            <button onclick="closeModal('unboxing-modal')" class="mt-6 w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg">Awesome!</button>
        </div>
    </div>


<script>
// --- Client-Side Game Logic (REWRITTEN) ---
document.addEventListener('DOMContentLoaded', () => {
    // --- State Management ---
    let gameState = {
        isLoggedIn: false,
        playerData: {},
        lastChatId: '0',
        selectedSkinIds: new Set(),
    };
    let gameData = { cases: {}, skins: {}, rarities: {}, ranks: {} };
    let updateInterval;
    let shopState = { tier: 1, sort: 'lth' };

    // --- DOM Elements ---
    const loginScreen = document.getElementById('login-screen');
    const gameContainer = document.getElementById('game-container');
    const usernameInput = document.getElementById('username-input');
    const passwordInput = document.getElementById('password-input');
    const loginButton = document.getElementById('login-button');
    const signupButton = document.getElementById('signup-button');
    const rememberMe = document.getElementById('remember-me');
    const showPassword = document.getElementById('show-password');
    const loginError = document.getElementById('login-error');
    const usernameDisplay = document.getElementById('username-display');
    const moneyStat = document.getElementById('money-stat');
    const clicksStat = document.getElementById('clicks-stat');
    const rankStat = document.getElementById('rank-stat');
    const clickButton = document.getElementById('click-button');
    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');
    const sendChatButton = document.getElementById('send-chat-button');
    const shopCaseList = document.getElementById('shop-case-list');
    const inventoryCaseList = document.getElementById('inventory-case-list');
    const inventorySkinList = document.getElementById('inventory-skin-list');
    const skinCount = document.getElementById('skin-count');
    const sellButtonContainer = document.getElementById('sell-button-container');
    const sellSelectedBtn = document.getElementById('sell-selected-btn');
    const staffPanelButton = document.getElementById('staff-panel-button');
    const leaderboardContent = document.getElementById('leaderboard-content');
    const logoutButton = document.getElementById('logout-button');
    const shopMoneyDisplay = document.getElementById('shop-money-display');
    const shopSort = document.getElementById('shop-sort');
    const shopTierButtons = document.getElementById('shop-tier-buttons');

    // --- Helper Functions ---
    const formatNumber = (num) => {
        if (num === null || num === undefined || isNaN(num)) return '0';
        num = Number(num);
        const suffixes = ['', 'K', 'M', 'B', 'T', 'q', 'Q', 's', 'S'];
        if (num < 1000) return Math.floor(num).toLocaleString();
        const i = Math.floor(Math.log10(Math.abs(num)) / 3);
        const shortNum = (num / Math.pow(1000, i)).toFixed(2);
        return shortNum + (suffixes[i] || '');
    };
    
    const getRarityStyle = (skinName) => {
        const rarityName = gameData.skins[skinName];
        if (!rarityName || !gameData.rarities[rarityName]) return 'border-gray-400 text-gray-300';
        const color = gameData.rarities[rarityName].color;
        const colorMap = {
            "gray": "border-gray-400 text-gray-300", "light blue": "border-cyan-400 text-cyan-300",
            "blue": "border-blue-500 text-blue-400", "purple": "border-purple-500 text-purple-400",
            "orange": "border-orange-500 text-orange-400", "red": "border-red-500 text-red-400",
        };
        return colorMap[color] || 'border-gray-400';
    };

    // --- API Helper ---
    async function apiRequest(endpoint, body = null, method = 'POST') {
        try {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(endpoint, options);
            const responseData = await response.json();
            if (!response.ok) throw new Error(responseData.message || 'An unknown error occurred.');
            return responseData;
        } catch (error) {
            console.error(`API Error on ${endpoint}:`, error);
            loginError.textContent = error.message;
            return { success: false, message: error.message };
        }
    }

    // --- Modals ---
    window.openModal = (modalId) => {
        document.getElementById(modalId)?.classList.add('active');
        // Lazy load content
        if (modalId === 'leaderboard-modal') renderLeaderboards();
    };
    window.closeModal = (modalId) => {
        document.getElementById(modalId)?.classList.remove('active');
        if (modalId === 'unboxing-modal') {
             const resultEl = document.getElementById('unboxing-result');
             resultEl.classList.add('scale-95', 'opacity-0');
             resultEl.classList.remove('scale-100', 'opacity-100');
        }
    };

    // --- UI Update Functions ---
    function updateUI() {
        if (!gameState.isLoggedIn) return;
        const player = gameState.playerData;
        usernameDisplay.textContent = usernameInput.value;
        moneyStat.textContent = `$${formatNumber(player.money)}`;
        clicksStat.textContent = formatNumber(player.clicks);
        rankStat.textContent = gameData.ranks[player.rank]?.name || 'Unranked';
        shopMoneyDisplay.textContent = formatNumber(player.money);
        staffPanelButton.classList.toggle('hidden', !['admin', 'moderator'].includes(player.role));
        updateInventory();
    }
    
    function updateChat(messages) {
        if (!messages || messages.length === 0) return;
        const shouldScroll = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 20;

        messages.forEach(msg => {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message player-message';
            msgDiv.innerHTML = `<span class="sender text-cyan-400">${msg.sender}: </span><span>${msg.msg}</span>`;
            chatBox.appendChild(msgDiv);
            gameState.lastChatId = msg.id;
        });

        if (shouldScroll) chatBox.scrollTop = chatBox.scrollHeight;
    }

    function renderShop() {
        shopCaseList.innerHTML = '';
        let cases = Object.entries(gameData.cases).filter(([, caseInfo]) => caseInfo.tier === shopState.tier);
        cases.sort(([,a],[,b]) => shopState.sort === 'htl' ? b.price - a.price : a.price - b.price);

        cases.forEach(([name, caseInfo]) => {
            const caseDiv = document.createElement('div');
            caseDiv.className = 'bg-gray-700 p-4 rounded-lg flex flex-col justify-between';
            caseDiv.innerHTML = `
                <div><h4 class="text-lg font-bold text-white truncate">${name}</h4><p class="text-green-400 font-mono">$${formatNumber(caseInfo.price)}</p></div>
                <div class="flex gap-2 mt-4">
                     <input type="number" value="1" min="1" max="100" class="w-16 bg-gray-800 text-white p-1 rounded text-center" id="buy-qty-${name.replace(/\W/g, '')}">
                     <button class="flex-grow bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-3 rounded-lg">Buy</button>
                </div>`;
            caseDiv.querySelector('button').onclick = async () => {
                const quantity = document.getElementById(`buy-qty-${name.replace(/\W/g, '')}`).value;
                const result = await apiRequest('/api/buy_case', { case_name: name, quantity });
                if (result.success) gameState.playerData = result.player_data;
                updateUI();
            };
            shopCaseList.appendChild(caseDiv);
        });
    }

    function updateInventory() {
        // Cases
        inventoryCaseList.innerHTML = '';
        const ownedCases = gameState.playerData.cases || {};
        Object.entries(ownedCases).sort(([a],[b]) => a.localeCompare(b)).forEach(([name, count]) => {
            if (count > 0) {
                const caseDiv = document.createElement('div');
                caseDiv.className = 'bg-gray-700 p-3 rounded-lg mb-2 flex justify-between items-center';
                caseDiv.innerHTML = `<div><h5 class="text-white font-bold">${name}</h5><p class="text-gray-400">Owned: ${count}</p></div><button class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Open</button>`;
                caseDiv.querySelector('button').onclick = () => handleOpenCase(name);
                inventoryCaseList.appendChild(caseDiv);
            }
        });

        // Skins
        inventorySkinList.innerHTML = '';
        const sortedSkins = (gameState.playerData.skins || []).sort((a,b) => b.value - a.value);
        skinCount.textContent = sortedSkins.length;
        sortedSkins.forEach(skin => {
            const skinDiv = document.createElement('div');
            const rarityStyle = getRarityStyle(skin.name);
            skinDiv.className = `skin-card bg-gray-800 p-2 rounded-lg border-2 border-transparent cursor-pointer ${rarityStyle}`;
            skinDiv.dataset.skinId = skin.id;
            skinDiv.innerHTML = `<p class="font-bold text-sm truncate">${skin.name}</p><p class="text-xs text-green-400 font-mono">$${formatNumber(skin.value)}</p>`;
            if (gameState.selectedSkinIds.has(skin.id)) skinDiv.classList.add('selected');
            skinDiv.onclick = () => {
                gameState.selectedSkinIds.has(skin.id) ? gameState.selectedSkinIds.delete(skin.id) : gameState.selectedSkinIds.add(skin.id);
                skinDiv.classList.toggle('selected');
                updateSellButton();
            };
            inventorySkinList.appendChild(skinDiv);
        });
        updateSellButton();
    }

    function updateSellButton() {
        const selectedCount = gameState.selectedSkinIds.size;
        sellButtonContainer.classList.toggle('hidden', selectedCount === 0);
        if (selectedCount > 0) {
            let totalValue = Array.from(gameState.selectedSkinIds).reduce((sum, id) => {
                const skin = gameState.playerData.skins.find(s => s.id === id);
                return sum + (skin ? skin.value : 0);
            }, 0);
            sellSelectedBtn.textContent = `Sell (${selectedCount}) for $${formatNumber(totalValue)}`;
        }
    }

    async function renderLeaderboards() {
        const data = await apiRequest('/api/leaderboards', null, 'GET');
        leaderboardContent.innerHTML = '';
        const boardTitles = { most_clicks: "Most Clicks", most_money: "Richest Players" };
        for (const [key, title] of Object.entries(boardTitles)) {
            const boardData = data[key] || [];
            let listHtml = `<div class="bg-gray-700 p-3 rounded-lg"><h4 class="text-white font-bold text-lg mb-2">${title}</h4><ol class="list-decimal list-inside space-y-1">`;
            boardData.slice(0, 50).forEach(p => listHtml += `<li class="truncate">${p.username} - <span class="font-mono text-green-300">${formatNumber(p.value)}</span></li>`);
            listHtml += '</ol></div>';
            leaderboardContent.innerHTML += listHtml;
        }
    }

    // --- Game Actions ---
    async function startGame(playerData) {
        gameState.isLoggedIn = true;
        gameState.playerData = playerData;
        loginScreen.classList.add('hidden');
        gameContainer.classList.remove('hidden');
        
        const [cases, skins, rarities, ranks] = await Promise.all([
            apiRequest('/api/game_data/cases', null, 'GET'),
            apiRequest('/api/game_data/skins', null, 'GET'),
            apiRequest('/api/game_data/rarities', null, 'GET'),
            apiRequest('/api/game_data/ranks', null, 'GET')
        ]);
        gameData = { cases, skins, rarities, ranks };
        
        setupShopControls();
        updateUI();
        updateInterval = setInterval(updateLoop, 3000);
    }

    async function handleLogin() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        if (!username || !password) return;
        loginError.textContent = '';
        
        const result = await apiRequest('/api/login', { username, password });
        if (result.success) {
            if (rememberMe.checked) localStorage.setItem('rememberedUsername', username);
            else localStorage.removeItem('rememberedUsername');
            startGame(result.player_data);
        }
    }

    async function handleSignup() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        if (!username || !password) return;
        loginError.textContent = '';
        const result = await apiRequest('/api/signup', { username, password });
        loginError.textContent = result.message;
    }

    async function handleOpenCase(caseName) {
        const result = await apiRequest('/api/open_case', { case_name: caseName });
        if (result.success) {
            gameState.playerData = result.player_data;
            updateUI();
            
            const item = result.item_won;
            const rarityStyle = getRarityStyle(item.name);
            document.getElementById('unboxed-item-name').textContent = item.name;
            document.getElementById('unboxed-item-name').className = `text-3xl font-bold ${rarityStyle.split(' ')[1]}`;
            document.getElementById('unboxed-item-value').textContent = `$${formatNumber(item.value)}`;
            document.getElementById('unboxed-item-card').className = `p-4 rounded-lg border-2 ${rarityStyle.split(' ')[0]}`;
            
            openModal('unboxing-modal');
            setTimeout(() => document.getElementById('unboxing-result').classList.remove('scale-95', 'opacity-0'), 50);
        } else {
            alert(result.message);
        }
    }
    
    async function handleSellSkins() {
        const ids = Array.from(gameState.selectedSkinIds);
        if (ids.length === 0) return;
        const result = await apiRequest('/api/sell_skins', { skin_ids: ids });
        if (result.success) {
            gameState.playerData = result.player_data;
            gameState.selectedSkinIds.clear();
            updateUI();
        } else {
            alert("Failed to sell skins.");
        }
    }
    
    function setupShopControls() {
        shopTierButtons.innerHTML = '';
        [...Array(20).keys()].forEach(i => {
            const tier = i + 1;
            const button = document.createElement('button');
            button.className = `tier-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg ${tier === shopState.tier ? 'active' : ''}`;
            button.textContent = `T${tier}`;
            button.onclick = () => {
                shopState.tier = tier;
                document.querySelectorAll('.tier-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                renderShop();
            };
            shopTierButtons.appendChild(button);
        });
        shopSort.onchange = (e) => { shopState.sort = e.target.value; renderShop(); };
    }

    // --- Main Game Loop ---
    async function updateLoop() {
        if (!gameState.isLoggedIn) return;
        const response = await apiRequest('/api/game_state', { last_chat_id: gameState.lastChatId });
        if (response.success) {
            gameState.playerData = response.player_data;
            updateUI();
            updateChat(response.new_global_messages);
        } else {
            alert("Connection lost. Please log in again.");
            clearInterval(updateInterval);
            window.location.reload();
        }
    }

    // --- Initial Setup & Event Listeners ---
    loginButton.onclick = handleLogin;
    signupButton.onclick = handleSignup;
    logoutButton.onclick = () => { clearInterval(updateInterval); window.location.reload(); };
    showPassword.onchange = () => { passwordInput.type = showPassword.checked ? 'text' : 'password'; };
    clickButton.onclick = async () => {
        const result = await apiRequest('/api/click');
        if (result.success) gameState.playerData = result.player_data;
        updateUI();
    };
    sendChatButton.onclick = async () => {
        if (!chatInput.value.trim()) return;
        await apiRequest('/api/chat/global', { message: chatInput.value });
        chatInput.value = '';
    };
    chatInput.onkeyup = (e) => { if (e.key === 'Enter') sendChatButton.click(); };
    sellSelectedBtn.onclick = handleSellSkins;

    // Load remembered username
    const rememberedUser = localStorage.getItem('rememberedUsername');
    if (rememberedUser) {
        usernameInput.value = rememberedUser;
        rememberMe.checked = true;
    }
});
</script>
</body>
</html>

